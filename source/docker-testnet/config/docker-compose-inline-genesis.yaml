# Atomica Aptos Local Testnet - Simplified with Inline Genesis
#
# Each validator generates genesis deterministically on startup
#
# Image Configuration:
#   - Defaults to ghcr.io/bomba-atomica/atomica-aptos/validator:latest
#   - Override with IMAGE_NAME environment variable
#
# Architecture:
# - 4 validator nodes with inline genesis generation
# - Shared genesis volume (writable - first validator to start generates it)
# - No separate genesis generation step needed
# - Node configs generated from template
#
# Usage:
#   1. Start testnet: docker compose -f docker-compose-inline-genesis.yaml up -d
#   2. Check status: docker compose -f docker-compose-inline-genesis.yaml ps
#   3. View logs: docker compose -f docker-compose-inline-genesis.yaml logs -f validator-0
#   4. Stop testnet: docker compose -f docker-compose-inline-genesis.yaml down

name: atomica-testnet

services:
  # Validator 0 - Primary (starts first, generates genesis)
  validator-0:
    image: "${IMAGE_NAME:-${VALIDATOR_IMAGE_REPO:-ghcr.io/bomba-atomica/atomica-aptos/validator}:${IMAGE_TAG:-latest}}"
    container_name: atomica-validator-0
    hostname: validator-0
    user: root
    networks:
      atomica-testnet:
        ipv4_address: 172.19.0.10
    volumes:
      - type: bind
        source: ./validator-entrypoint.sh
        target: /opt/aptos/entrypoint.sh
        read_only: true
      - type: bind
        source: ./node-config.template.yaml
        target: /opt/aptos/config/node-config.template.yaml
        read_only: true
      - type: bind
        source: ./genesis-artifacts
        target: /opt/aptos/genesis-artifacts
        read_only: true
      - type: volume
        source: atomica-genesis-shared
        target: /opt/aptos/var/genesis
      - type: bind
        source: ./validators/validator-0
        target: /opt/aptos/var/identity
        read_only: true
      - type: volume
        source: atomica-validator-0-data
        target: /opt/aptos/var/data
    entrypoint: ["/bin/bash", "/opt/aptos/entrypoint.sh"]
    ports:
      - "8080:8080"  # REST API
      - "9101:9101"  # Metrics
    expose:
      - 8080
      - 9101
      - 6180
      - 6181
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/v1 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    environment:
      - VALIDATOR_INDEX=0
      - NUM_VALIDATORS=${NUM_VALIDATORS:-2}
      - CHAIN_ID=4
      - RUST_LOG=info
      - RUST_BACKTRACE=1

  # Validator 1
  validator-1:
    image: "${IMAGE_NAME:-${VALIDATOR_IMAGE_REPO:-ghcr.io/bomba-atomica/atomica-aptos/validator}:${IMAGE_TAG:-latest}}"
    container_name: atomica-validator-1
    hostname: validator-1
    user: root
    depends_on:
      validator-0:
        condition: service_healthy
    networks:
      atomica-testnet:
        ipv4_address: 172.19.0.11
    volumes:
      - type: bind
        source: ./validator-entrypoint.sh
        target: /opt/aptos/entrypoint.sh
        read_only: true
      - type: bind
        source: ./node-config.template.yaml
        target: /opt/aptos/config/node-config.template.yaml
        read_only: true
      - type: bind
        source: ./genesis-artifacts
        target: /opt/aptos/genesis-artifacts
        read_only: true
      - type: volume
        source: atomica-genesis-shared
        target: /opt/aptos/var/genesis
      - type: bind
        source: ./validators/validator-1
        target: /opt/aptos/var/identity
        read_only: true
      - type: volume
        source: atomica-validator-1-data
        target: /opt/aptos/var/data
    entrypoint: ["/bin/bash", "/opt/aptos/entrypoint.sh"]
    ports:
      - "8081:8080"  # REST API
      - "9102:9101"  # Metrics
    expose:
      - 8080
      - 9101
      - 6180
      - 6181
    environment:
      - VALIDATOR_INDEX=1
      - NUM_VALIDATORS=${NUM_VALIDATORS:-2}
      - CHAIN_ID=4
      - RUST_LOG=info
      - RUST_BACKTRACE=1

  # Validator 2
  validator-2:
    image: "${IMAGE_NAME:-${VALIDATOR_IMAGE_REPO:-ghcr.io/bomba-atomica/atomica-aptos/validator}:${IMAGE_TAG:-latest}}"
    container_name: atomica-validator-2
    hostname: validator-2
    user: root
    depends_on:
      validator-0:
        condition: service_healthy
    networks:
      atomica-testnet:
        ipv4_address: 172.19.0.12
    volumes:
      - type: bind
        source: ./validator-entrypoint.sh
        target: /opt/aptos/entrypoint.sh
        read_only: true
      - type: bind
        source: ./node-config.template.yaml
        target: /opt/aptos/config/node-config.template.yaml
        read_only: true
      - type: bind
        source: ./genesis-artifacts
        target: /opt/aptos/genesis-artifacts
        read_only: true
      - type: volume
        source: atomica-genesis-shared
        target: /opt/aptos/var/genesis
      - type: bind
        source: ./validators/validator-2
        target: /opt/aptos/var/identity
        read_only: true
      - type: volume
        source: atomica-validator-2-data
        target: /opt/aptos/var/data
    entrypoint: ["/bin/bash", "/opt/aptos/entrypoint.sh"]
    ports:
      - "8082:8080"  # REST API
      - "9103:9101"  # Metrics
    expose:
      - 8080
      - 9101
      - 6180
      - 6181
    environment:
      - VALIDATOR_INDEX=2
      - NUM_VALIDATORS=4
      - CHAIN_ID=4
      - RUST_LOG=info
      - RUST_BACKTRACE=1

  # Validator 3
  validator-3:
    image: "${IMAGE_NAME:-${VALIDATOR_IMAGE_REPO:-ghcr.io/bomba-atomica/atomica-aptos/validator}:${IMAGE_TAG:-latest}}"
    container_name: atomica-validator-3
    hostname: validator-3
    user: root
    depends_on:
      validator-0:
        condition: service_healthy
    networks:
      atomica-testnet:
        ipv4_address: 172.19.0.13
    volumes:
      - type: bind
        source: ./validator-entrypoint.sh
        target: /opt/aptos/entrypoint.sh
        read_only: true
      - type: bind
        source: ./node-config.template.yaml
        target: /opt/aptos/config/node-config.template.yaml
        read_only: true
      - type: bind
        source: ./genesis-artifacts
        target: /opt/aptos/genesis-artifacts
        read_only: true
      - type: volume
        source: atomica-genesis-shared
        target: /opt/aptos/var/genesis
      - type: bind
        source: ./validators/validator-3
        target: /opt/aptos/var/identity
        read_only: true
      - type: volume
        source: atomica-validator-3-data
        target: /opt/aptos/var/data
    entrypoint: ["/bin/bash", "/opt/aptos/entrypoint.sh"]
    ports:
      - "8083:8080"  # REST API
      - "9104:9101"  # Metrics
    expose:
      - 8080
      - 9101
      - 6180
      - 6181
    environment:
      - VALIDATOR_INDEX=3
      - NUM_VALIDATORS=4
      - CHAIN_ID=4
      - RUST_LOG=info
      - RUST_BACKTRACE=1

networks:
  atomica-testnet:
    name: atomica-testnet
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.19.0.0/16
          gateway: 172.19.0.1

volumes:
  atomica-genesis-shared:
    name: atomica-genesis-shared
  atomica-validator-0-data:
    name: atomica-validator-0-data
  atomica-validator-1-data:
    name: atomica-validator-1-data
  atomica-validator-2-data:
    name: atomica-validator-2-data
  atomica-validator-3-data:
    name: atomica-validator-3-data
