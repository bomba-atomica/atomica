#!/bin/bash
#
# Genesis generation script for multi-validator Aptos testnet
# This script runs inside a Docker container with the aptos CLI available
#
# Usage: ./generate-genesis.sh <num_validators> <chain_id> <base_ip>
#
# Arguments:
#   num_validators: Number of validators to generate (1-7)
#   chain_id: Chain ID for the network (e.g., 4)
#   base_ip: Base IP for validators (e.g., 172.19.0.10 means validators get .10, .11, etc.)
#
# Output structure in /workspace:
#   /workspace/output/genesis.blob
#   /workspace/output/waypoint.txt
#   /workspace/validator-{0,1,...}/
#       validator-identity.yaml
#       node-config.yaml
#

set -euo pipefail

# Enable debug mode if DEBUG_TESTNET is set
if [ "${DEBUG_TESTNET:-}" = "1" ] || [ "${DEBUG_TESTNET:-}" = "true" ]; then
    set -x
    DEBUG=1
else
    DEBUG=0
fi

debug() {
    if [ "$DEBUG" = "1" ]; then
        echo "[DEBUG $(date -Iseconds)] $*" >&2
    fi
}

NUM_VALIDATORS="${1:-4}"
CHAIN_ID="${2:-4}"
BASE_IP="${3:-172.19.0.10}"
STAKE_AMOUNT="100000000000000"  # 1M APT in octas
# Treasury account will be randomly generated (production-like)

WORKSPACE="/workspace"
cd "$WORKSPACE"

debug "Genesis generation started with NUM_VALIDATORS=$NUM_VALIDATORS CHAIN_ID=$CHAIN_ID BASE_IP=$BASE_IP"

echo "=== Generating genesis for ${NUM_VALIDATORS} validators (chain_id=${CHAIN_ID}) ==="

# Parse base IP to get the base octets and starting number
IFS='.' read -r ip1 ip2 ip3 ip4 <<< "$BASE_IP"

# Generate usernames array for layout
USERNAMES=""
for i in $(seq 0 $((NUM_VALIDATORS - 1))); do
    if [ -n "$USERNAMES" ]; then
        USERNAMES="${USERNAMES}, \"validator-${i}\""
    else
        USERNAMES="\"validator-${i}\""
    fi
done

# Step 1: Generate layout template and customize it
echo "Step 1/6: Generating layout..."
cat > layout.yaml << EOF
---
root_key: "0x5243ca72b0766d9e9cbf2debf6153443b01a1e0e6d086c7ea206eaf6f8043956"
users: [${USERNAMES}]
chain_id: ${CHAIN_ID}
allow_new_validators: false
epoch_duration_secs: 7200
is_test: true
min_stake: 100000000000000
min_voting_threshold: 100000000000000
max_stake: 10000000000000000
recurring_lockup_duration_secs: 86400
required_proposer_stake: 100000000000000
rewards_apy_percentage: 10
voting_duration_secs: 43200
voting_power_increase_limit: 20
employee_vesting_start: 1663456089
employee_vesting_period_duration: 5184000
EOF

# Step 2: Generate validator keys
echo "Step 2/6: Generating validator keys..."
for i in $(seq 0 $((NUM_VALIDATORS - 1))); do
    username="validator-${i}"
    mkdir -p "$username"
    aptos genesis generate-keys --output-dir "$username" --assume-yes
done

# Step 3: Set validator configurations
echo "Step 3/6: Setting validator configurations..."
mkdir -p genesis-repo

for i in $(seq 0 $((NUM_VALIDATORS - 1))); do
    username="validator-${i}"
    validator_ip="${ip1}.${ip2}.${ip3}.$((ip4 + i))"

    debug "Setting configuration for $username at IP $validator_ip"

    mkdir -p "genesis-repo/${username}"

    aptos genesis set-validator-configuration \
        --username "$username" \
        --owner-public-identity-file "${username}/public-keys.yaml" \
        --validator-host "${validator_ip}:6180" \
        --full-node-host "${validator_ip}:6182" \
        --stake-amount "$STAKE_AMOUNT" \
        --commission-percentage 0 \
        --local-repository-dir genesis-repo

    debug "Configured $username with validator-host=${validator_ip}:6180"
done

# Step 4: Copy layout to genesis repo and find framework
echo "Step 4/6: Setting up genesis repository..."
cp layout.yaml genesis-repo/

# Find and copy framework.mrb
FRAMEWORK_PATHS=(
    "/aptos-framework/move/head.mrb"
    "/opt/aptos/framework/framework.mrb"
    "/aptos/framework.mrb"
)

FRAMEWORK_FOUND=false
for fpath in "${FRAMEWORK_PATHS[@]}"; do
    if [ -f "$fpath" ]; then
        echo "  Found framework at: $fpath"
        cp "$fpath" genesis-repo/framework.mrb
        FRAMEWORK_FOUND=true
        break
    fi
done

if [ "$FRAMEWORK_FOUND" = false ]; then
    echo "ERROR: Could not find framework.mrb in any known location"
    exit 1
fi

# Step 5: Setup git structure (required by aptos genesis)
echo "Step 5/6: Finalizing genesis repository..."
aptos genesis setup-git \
    --layout-file layout.yaml \
    --local-repository-dir genesis-repo

# Step 6: Generate genesis blob and waypoint
echo "Step 6/6: Generating genesis.blob and waypoint..."
mkdir -p output
aptos genesis generate-genesis \
    --local-repository-dir genesis-repo \
    --output-dir output

# Step 7: Create node configs for each validator
echo "Creating node configurations..."
for i in $(seq 0 $((NUM_VALIDATORS - 1))); do
    username="validator-${i}"
    
    debug "Creating node config for $username with listen_address=/ip4/0.0.0.0/tcp/6180"
    
    cat > "${username}/node-config.yaml" << 'NODECONFIG'
base:
  role: "validator"
  data_dir: "/opt/aptos/data"
  waypoint:
    from_file: "/opt/aptos/genesis/waypoint.txt"

consensus:
  safety_rules:
    service:
      type: "local"
    backend:
      type: "on_disk_storage"
      path: "/opt/aptos/data/safety-data.json"
      namespace: ~
    initial_safety_rules_config:
      from_file:
        waypoint:
          from_file: "/opt/aptos/genesis/waypoint.txt"
        identity_blob_path: "/opt/aptos/identity/validator-identity.yaml"

execution:
  genesis_file_location: "/opt/aptos/genesis/genesis.blob"

validator_network:
  discovery_method: "onchain"
  listen_address: "/ip4/0.0.0.0/tcp/6180"
  mutual_authentication: true
  network_id: "validator"
  identity:
    type: "from_file"
    path: "/opt/aptos/identity/validator-identity.yaml"

api:
  enabled: true
  address: "0.0.0.0:8080"

storage:
  enable_indexer: false
  rocksdb_configs:
    enable_storage_sharding: false

inspection_service:
  address: "0.0.0.0"
  port: 9101

logger:
  level: INFO
NODECONFIG

    debug "Created node config for $username - config includes validator_network.listen_address"
done

echo ""
echo "=== Genesis generation complete! ==="
echo "  Genesis blob: ${WORKSPACE}/output/genesis.blob"
echo "  Waypoint:     ${WORKSPACE}/output/waypoint.txt"
echo "  Validators:   ${NUM_VALIDATORS}"

# Print waypoint for convenience
echo ""
echo "Waypoint:"
cat output/waypoint.txt
