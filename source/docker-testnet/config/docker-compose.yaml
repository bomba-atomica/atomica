# Atomica Aptos Local Testnet - Multi-Validator Configuration
#
# This compose file sets up a 4-validator testnet using pre-built validator
# images published by the atomica-aptos repository.
#
# Default Configuration:
#   - Uses published image: ghcr.io/bomba-atomica/atomica-aptos/validator:latest
#   - No build step required - just start the testnet
#   - Images are built and published by atomica-aptos CI/CD
#   - Image tags include git commit hash for traceability
#
# Image Selection:
#   You can specify different image versions via environment variables:
#   - VALIDATOR_IMAGE_REPO: Image repository (default: ghcr.io/bomba-atomica/atomica-aptos/validator)
#   - IMAGE_TAG: Specific version tag (default: latest)
#
#   Example: Use a specific commit version
#     IMAGE_TAG=abc1234 docker compose up -d
#
# Architecture:
# - 4 validator nodes
# - Shared genesis volume for coordination
# - Exposed REST APIs (8080-8083) and metrics (9101-9104)
#
# Usage:
#   1. Start testnet: docker compose up -d (or make start)
#   2. Check status: docker compose ps (or make status)
#   3. View logs: docker compose logs -f validator-0
#   4. Stop testnet: docker compose down



services:
  # Validator 0 (Primary - generates genesis)
  validator-0:
    image: "${VALIDATOR_IMAGE_REPO:-aptoslabs/validator}:${IMAGE_TAG:-devnet}"
    container_name: atomica-validator-0
    hostname: validator-0
    networks:
      zapatos-testnet:
        ipv4_address: 172.19.0.10
    volumes:
      - type: volume
        source: zapatos-genesis
        target: /opt/aptos/var
      - type: bind
        source: ./validator-config.yaml
        target: /opt/aptos/config.yaml
    command: >
      /usr/local/bin/aptos-node
      --test
      --test-dir /opt/aptos/var/
      --test-config-override /opt/aptos/config.yaml
    ports:
      - "8080:8080"  # REST API
      - "9101:9101"  # Metrics
    expose:
      - 8080  # REST API
      - 9101  # Metrics
      - 6180  # Validator network
      - 6181  # VFN network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/v1 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    environment:
      - RUST_LOG=info
      - RUST_BACKTRACE=1

  # Validator 1
  validator-1:
    image: "${VALIDATOR_IMAGE_REPO:-aptoslabs/validator}:${IMAGE_TAG:-devnet}"
    container_name: atomica-validator-1
    hostname: validator-1
    depends_on:
      validator-0:
        condition: service_healthy
    networks:
      zapatos-testnet:
        ipv4_address: 172.19.0.11
    volumes:
      - type: volume
        source: zapatos-genesis
        target: /opt/aptos/var
        read_only: true
      - type: volume
        source: zapatos-validator-1-data
        target: /opt/aptos/data
      - type: bind
        source: ./validator-config.yaml
        target: /opt/aptos/config.yaml
    command: >
      /bin/bash -c "
      echo 'Waiting for genesis from validator-0...';
      while [ ! -f /opt/aptos/var/genesis.blob ]; do
        sleep 2;
      done;
      echo 'Genesis found, starting validator-1...';
      /usr/local/bin/aptos-node
      --test
      --test-dir /opt/aptos/data/
      --test-config-override /opt/aptos/config.yaml
      "
    ports:
      - "8081:8080"  # REST API
      - "9102:9101"  # Metrics
    expose:
      - 8080
      - 9101
      - 6180
      - 6181
    environment:
      - RUST_LOG=info
      - RUST_BACKTRACE=1

  # Validator 2
  validator-2:
    image: "${VALIDATOR_IMAGE_REPO:-aptoslabs/validator}:${IMAGE_TAG:-devnet}"
    container_name: atomica-validator-2
    hostname: validator-2
    depends_on:
      validator-0:
        condition: service_healthy
    networks:
      zapatos-testnet:
        ipv4_address: 172.19.0.12
    volumes:
      - type: volume
        source: zapatos-genesis
        target: /opt/aptos/var
        read_only: true
      - type: volume
        source: zapatos-validator-2-data
        target: /opt/aptos/data
      - type: bind
        source: ./validator-config.yaml
        target: /opt/aptos/config.yaml
    command: >
      /bin/bash -c "
      echo 'Waiting for genesis from validator-0...';
      while [ ! -f /opt/aptos/var/genesis.blob ]; do
        sleep 2;
      done;
      echo 'Genesis found, starting validator-2...';
      /usr/local/bin/aptos-node
      --test
      --test-dir /opt/aptos/data/
      --test-config-override /opt/aptos/config.yaml
      "
    ports:
      - "8082:8080"  # REST API
      - "9103:9101"  # Metrics
    expose:
      - 8080
      - 9101
      - 6180
      - 6181
    environment:
      - RUST_LOG=info
      - RUST_BACKTRACE=1

  # Validator 3
  validator-3:
    image: "${VALIDATOR_IMAGE_REPO:-aptoslabs/validator}:${IMAGE_TAG:-devnet}"
    container_name: atomica-validator-3
    hostname: validator-3
    depends_on:
      validator-0:
        condition: service_healthy
    networks:
      zapatos-testnet:
        ipv4_address: 172.19.0.13
    volumes:
      - type: volume
        source: zapatos-genesis
        target: /opt/aptos/var
        read_only: true
      - type: volume
        source: zapatos-validator-3-data
        target: /opt/aptos/data
      - type: bind
        source: ./validator-config.yaml
        target: /opt/aptos/config.yaml
    command: >
      /bin/bash -c "
      echo 'Waiting for genesis from validator-0...';
      while [ ! -f /opt/aptos/var/genesis.blob ]; do
        sleep 2;
      done;
      echo 'Genesis found, starting validator-3...';
      /usr/local/bin/aptos-node
      --test
      --test-dir /opt/aptos/data/
      --test-config-override /opt/aptos/config.yaml
      "
    ports:
      - "8083:8080"  # REST API
      - "9104:9101"  # Metrics
    expose:
      - 8080
      - 9101
      - 6180
      - 6181
    environment:
      - RUST_LOG=info
      - RUST_BACKTRACE=1

  # Optional: Faucet service (useful for testing)
  faucet:
    image: "${VALIDATOR_IMAGE_REPO:-aptoslabs/validator}:${IMAGE_TAG:-devnet}"
    container_name: atomica-faucet
    depends_on:
      validator-0:
        condition: service_healthy
    networks:
      zapatos-testnet:
        ipv4_address: 172.19.0.20
    volumes:
      - type: volume
        source: zapatos-genesis
        target: /opt/aptos/var
        read_only: true
    command:
      - /bin/bash
      - -c
      - |
        echo 'Waiting for validator mint.key...'
        for i in {1..30}; do
          if [[ -s /opt/aptos/var/mint.key ]]; then
            echo 'Found mint.key, starting faucet...'
            sleep 2
            exec /usr/local/bin/aptos-faucet-service run-simple \
              --key-file-path /opt/aptos/var/mint.key \
              --chain-id TESTING \
              --node-url http://172.19.0.10:8080
          fi
          sleep 2
        done
        echo 'ERROR: Validator did not generate mint.key'
        exit 1
    ports:
      - "8000:8081"  # Faucet service
    restart: unless-stopped
    profiles:
      - with-faucet

networks:
  zapatos-testnet:
    name: "${TESTNET_NAME:-atomica-testnet}"
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: "${SUBNET:-172.19.0.0/16}"
          gateway: "${GATEWAY:-172.19.0.1}"

volumes:
  zapatos-genesis:
    name: atomica-genesis
  zapatos-validator-1-data:
    name: atomica-validator-1-data
  zapatos-validator-2-data:
    name: atomica-validator-2-data
  zapatos-validator-3-data:
    name: atomica-validator-3-data
