# Atomica Aptos Local Testnet - Multi-Validator Configuration
#
# This compose file sets up a single-node or multi-node testnet using validator images.
#
# Image Configuration:
#   - Defaults to ghcr.io/bomba-atomica/atomica-aptos/validator:latest
#   - Override with IMAGE_NAME environment variable
#
# Architecture:
# - 4 validator nodes
# - Shared genesis volume for coordination
# - Exposed REST APIs (8080-8083) and metrics (9101-9104)
#
# Usage:
#   1. Start testnet: docker compose up -d
#   2. Check status: docker compose ps
#   3. View logs: docker compose logs -f validator-0
#   4. Stop testnet: docker compose down

name: atomica-testnet

services:
  # Validator 0
  validator-0:
    image: "${IMAGE_NAME:-${VALIDATOR_IMAGE_REPO:-ghcr.io/bomba-atomica/atomica-aptos/validator}:${IMAGE_TAG:-latest}}"
    container_name: atomica-validator-0
    hostname: validator-0
    user: root
    networks:
      atomica-testnet:
        ipv4_address: 172.19.0.10
    volumes:
      - type: bind
        source: ./genesis-artifacts
        target: /opt/aptos/var/genesis
        read_only: true
      - type: bind
        source: ./validators/validator-0
        target: /opt/aptos/var/identity
        read_only: true
      - type: volume
        source: atomica-validator-0-data
        target: /opt/aptos/var/data
      - type: bind
        source: ./validators/validator-0/node-config.yaml
        target: /opt/aptos/var/etc/node-config.yaml
    command: >
      -f /opt/aptos/var/etc/node-config.yaml
    ports:
      - "8080:8080"  # REST API
      - "9101:9101"  # Metrics
    expose:
      - 8080  # REST API
      - 9101  # Metrics
      - 6180  # Validator network
      - 6181  # VFN network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/v1 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    environment:
      - RUST_LOG=info
      - RUST_BACKTRACE=1

  # Validator 1
  validator-1:
    image: "${IMAGE_NAME:-${VALIDATOR_IMAGE_REPO:-ghcr.io/bomba-atomica/atomica-aptos/validator}:${IMAGE_TAG:-latest}}"
    container_name: atomica-validator-1
    hostname: validator-1
    user: root
    depends_on:
      validator-0:
        condition: service_healthy
    networks:
      atomica-testnet:
        ipv4_address: 172.19.0.11
    volumes:
      - type: bind
        source: ./genesis-artifacts
        target: /opt/aptos/var/genesis
        read_only: true
      - type: bind
        source: ./validators/validator-1
        target: /opt/aptos/var/identity
        read_only: true
      - type: volume
        source: atomica-validator-1-data
        target: /opt/aptos/var/data
      - type: bind
        source: ./validators/validator-1/node-config.yaml
        target: /opt/aptos/var/etc/node-config.yaml
    command: >
      -f /opt/aptos/var/etc/node-config.yaml
    ports:
      - "8081:8080"  # REST API
      - "9102:9101"  # Metrics
    expose:
      - 8080
      - 9101
      - 6180
      - 6181
    environment:
      - RUST_LOG=info
      - RUST_BACKTRACE=1

  # Validator 2
  validator-2:
    image: "${IMAGE_NAME:-${VALIDATOR_IMAGE_REPO:-ghcr.io/bomba-atomica/atomica-aptos/validator}:${IMAGE_TAG:-latest}}"
    container_name: atomica-validator-2
    hostname: validator-2
    user: root
    depends_on:
      validator-0:
        condition: service_healthy
    networks:
      atomica-testnet:
        ipv4_address: 172.19.0.12
    volumes:
      - type: bind
        source: ./genesis-artifacts
        target: /opt/aptos/var/genesis
        read_only: true
      - type: bind
        source: ./validators/validator-2
        target: /opt/aptos/var/identity
        read_only: true
      - type: volume
        source: atomica-validator-2-data
        target: /opt/aptos/var/data
      - type: bind
        source: ./validators/validator-2/node-config.yaml
        target: /opt/aptos/var/etc/node-config.yaml
    command: >
      -f /opt/aptos/var/etc/node-config.yaml
    ports:
      - "8082:8080"  # REST API
      - "9103:9101"  # Metrics
    expose:
      - 8080
      - 9101
      - 6180
      - 6181
    environment:
      - RUST_LOG=info
      - RUST_BACKTRACE=1

  # Validator 3
  validator-3:
    image: "${IMAGE_NAME:-${VALIDATOR_IMAGE_REPO:-ghcr.io/bomba-atomica/atomica-aptos/validator}:${IMAGE_TAG:-latest}}"
    container_name: atomica-validator-3
    hostname: validator-3
    user: root
    depends_on:
      validator-0:
        condition: service_healthy
    networks:
      atomica-testnet:
        ipv4_address: 172.19.0.13
    volumes:
      - type: bind
        source: ./genesis-artifacts
        target: /opt/aptos/var/genesis
        read_only: true
      - type: bind
        source: ./validators/validator-3
        target: /opt/aptos/var/identity
        read_only: true
      - type: volume
        source: atomica-validator-3-data
        target: /opt/aptos/var/data
      - type: bind
        source: ./validators/validator-3/node-config.yaml
        target: /opt/aptos/var/etc/node-config.yaml
    command: >
      -f /opt/aptos/var/etc/node-config.yaml
    ports:
      - "8083:8080"  # REST API
      - "9104:9101"  # Metrics
    expose:
      - 8080
      - 9101
      - 6180
      - 6181
    environment:
      - RUST_LOG=info
      - RUST_BACKTRACE=1

  # Optional: Faucet service (useful for testing)
  faucet:
    image: "${IMAGE_NAME:-${VALIDATOR_IMAGE_REPO:-ghcr.io/bomba-atomica/atomica-aptos/validator}:${IMAGE_TAG:-latest}}"
    container_name: atomica-faucet
    depends_on:
      validator-0:
        condition: service_healthy
    networks:
      atomica-testnet:
        ipv4_address: 172.19.0.20
    volumes:
      - type: volume
        source: atomica-genesis
        target: /opt/aptos/var
        read_only: true
    command:
      - /bin/bash
      - -c
      - |
        echo 'Waiting for validator mint.key...'
        for i in {1..30}; do
          if [[ -s /opt/aptos/var/mint.key ]]; then
            echo 'Found mint.key, starting faucet...'
            sleep 2
            exec /usr/local/bin/aptos-faucet-service run-simple \
              --key-file-path /opt/aptos/var/mint.key \
              --chain-id TESTING \
              --node-url http://172.19.0.10:8080
          fi
          sleep 2
        done
        echo 'ERROR: Validator did not generate mint.key'
        exit 1
    ports:
      - "8000:8081"  # Faucet service
    restart: unless-stopped
    profiles:
      - with-faucet

networks:
  atomica-testnet:
    name: atomica-testnet
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.19.0.0/16
          gateway: 172.19.0.1

volumes:
  atomica-validator-0-data:
    name: atomica-validator-0-data
  atomica-validator-1-data:
    name: atomica-validator-1-data
  atomica-validator-2-data:
    name: atomica-validator-2-data
  atomica-validator-3-data:
    name: atomica-validator-3-data
