import { describe, test, expect, beforeAll, afterAll } from "bun:test";
import { DockerTestnet } from "../src/index";
import { AptosClient } from "aptos";
import {
    registerCleanupHandlers,
    setGlobalTestnet,
    initializeTestnet,
    performCleanup,
    waitForNetworkStabilization,
} from "./helpers/testnet-lifecycle";

// Register cleanup handlers once at module load
registerCleanupHandlers();

describe("Faucet Sanity Checks", () => {
    let testnet: DockerTestnet;
    let client: AptosClient;
    const NUM_VALIDATORS = 2;

    beforeAll(async () => {
        testnet = await initializeTestnet(NUM_VALIDATORS);
        client = new AptosClient(testnet.validatorApiUrl(0));
        await waitForNetworkStabilization(testnet);
    }, 300000); // 5 min timeout for setup

    afterAll(async () => {
        await performCleanup("Faucet sanity tests completed");
        setGlobalTestnet(undefined);
    });

    test("should verify validator identities and resources", async () => {
        expect(testnet).toBeDefined();

        // 1. Get validator set from on-chain
        const validatorSet = await client.getAccountResource("0x1", "0x1::stake::ValidatorSet");
        const activeValidators = (validatorSet.data as any).active_validators.map((v: any) => v.addr.toLowerCase());
        console.log("On-chain active validators:", activeValidators);

        // 2. Check each local validator account
        for (let i = 0; i < NUM_VALIDATORS; i++) {
            const validatorAccount = await testnet.getValidatorAccount(i);
            const addr = validatorAccount.address().hex().toLowerCase();
            console.log(`Local Validator ${i} address: ${addr}`);
        }

        // PROBE Root Account
        try {
            const rootAcc = testnet.getRootAccount();
            const rootAddr = rootAcc.address().hex();
            const acc = await client.getAccount(rootAddr);
            console.log(`Root account address: ${rootAddr}`);
            console.log(`Root account auth key on-chain: ${acc.authentication_key}`);
            console.log(`Root account auth key derived:  ${rootAcc.authKey().hex()}`);
        } catch (e) {
            console.log(`Failed to probe root account: ${(e as Error).message}`);
        }

        // Total Supply Probe
        try {
            const coinInfo = await client.getAccountResource("0x1", "0x1::coin::CoinInfo<0x1::aptos_coin::AptosCoin>");
            console.log("Total Supply:", (coinInfo.data as any).supply.vec[0].integer.value);
        } catch (e) {
            console.log("Failed to fetch total supply:", (e as Error).message);
        }
    });
});
