# Docker Testnet SDK Key Management

## Overview

Both the TypeScript and Rust Docker testnet SDKs follow the same principle:

**✓ Keys are read from Docker container storage - NOT generated by the SDKs**

## How It Works

### Genesis Process

1. When the testnet starts, genesis is generated using `generate-genesis.sh`
2. This script creates:
   - Root account keys → stored in `genesis-artifacts/root-account-private-keys.yaml`
   - Validator keys → stored in `validators/validator-{i}/private-keys.yaml`
3. The genesis.blob contains the initial blockchain state with these accounts
4. The root account's public key is used to rotate the Core Resources account's auth key

### TypeScript SDK (src/index.ts)

**Reading Validator Keys:**
```typescript
async getValidatorAccount(index: number): Promise<AptosAccount> {
    const identityPath = pathResolve(
        this.composeDir,
        "validators",
        `validator-${index}`,
        "private-keys.yaml"
    );
    const content = readFileSync(identityPath, "utf-8");
    const addrMatch = content.match(/account_address:\s*([a-fA-F0-9]+)/);
    const keyMatch = content.match(/account_private_key:\s*"0x([a-fA-F0-9]+)"/);
    // ...
}
```

**Reading Faucet/Root Account Keys:**
```typescript
getFaucetAccount(): AptosAccount {
    const rootKeysPath = pathResolve(
        this.composeDir,
        "genesis-artifacts",
        "root-account-private-keys.yaml"
    );
    const content = readFileSync(rootKeysPath, "utf-8");
    const keyMatch = content.match(/account_private_key:\s*"0x([a-fA-F0-9]+)"/);
    // ...
}
```

### Rust SDK (src/lib.rs)

**Reading Validator Keys:**
```rust
pub fn get_validator_account(&self, index: usize) -> anyhow::Result<AccountInfo> {
    let path = PathBuf::from(&self.compose_dir)
        .join("validators")
        .join(format!("validator-{}", index))
        .join("private-keys.yaml");
    AccountInfo::from_yaml_file(&path)
}
```

**Reading Faucet/Root Account Keys:**
```rust
pub fn get_faucet_account(&self) -> anyhow::Result<AccountInfo> {
    let path = PathBuf::from(&self.compose_dir)
        .join("genesis-artifacts")
        .join("root-account-private-keys.yaml");
    AccountInfo::from_yaml_file(&path)
}
```

## Key Storage Locations

```
docker-testnet/config/
├── genesis-artifacts/              # Copied from genesis-workspace/output
│   ├── root-account-private-keys.yaml   # Root/faucet account keys
│   ├── genesis.blob                     # Initial blockchain state
│   └── waypoint.txt
│
└── validators/                     # Generated per validator
    ├── validator-0/
    │   └── private-keys.yaml       # Validator 0 keys
    ├── validator-1/
    │   └── private-keys.yaml       # Validator 1 keys
    └── ...
```

## Key Points

1. **No Key Generation in SDKs**: Neither SDK generates cryptographic keys
2. **Read from Storage**: Both SDKs read pre-generated keys from YAML files
3. **Genesis Synchronization**: The running testnet always uses the genesis artifacts on disk
4. **Auth Key Rotation**: During genesis, the Core Resources account (0xA550C18) has its auth key rotated to match the root public key from layout.yaml

## Testing

### TypeScript Test
```bash
cd typescript-sdk
bun test test/faucet.test.ts
```

The test demonstrates:
- Reading validator account keys
- Reading faucet account keys
- Using those keys to sign transactions
- Keys match the on-chain auth keys (when genesis is in sync)

### Rust Test
```bash
cd rust-sdk
cargo test test_read_keys_from_storage -- --nocapture
```

Output:
```
✓ Validator 0 account read from storage:
  Address: 0x96d87a765e666ba322321f6c8de4168aba2881bfc3b3bf7f4f331efc81fd79e2
  Private key: 0x3c8b26c190c31cf713 (from validators/validator-0/private-keys.yaml)

✓ Faucet account read from storage:
  Address: 0xde41b145a59a4716c27172397e7c97ad1196e0ffcaf045736e40cc69869c9b25
  Private key: 0xf9b7c39cee05b8bfd6 (from genesis-artifacts/root-account-private-keys.yaml)

✓ Rust SDK reads keys from Docker container storage (does NOT generate keys)
```

## Important: Auth Key Synchronization

For transactions to succeed, the keys read from storage MUST match the on-chain state. This is ensured by:

1. Both SDKs calling `docker compose down -v` before starting (removes old state)
2. Regenerating genesis before starting the testnet
3. Copying genesis artifacts to the config directory
4. Starting Docker containers with the fresh genesis.blob

If you see `INVALID_AUTH_KEY` errors, it means:
- The testnet is running with old genesis
- But the SDK is reading new keys from disk
- Solution: Restart the testnet to regenerate and sync genesis
