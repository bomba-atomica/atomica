# Example: Docker Testnet CI Workflow
#
# This workflow demonstrates how to run docker-testnet tests in GitHub Actions.
# The GITHUB_TOKEN automatically provides access to GHCR packages in the same org/repo.

name: Docker Testnet Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  docker-testnet:
    runs-on: ubuntu-latest

    # Required for GHCR access
    permissions:
      packages: read
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: source/atomica-web/package-lock.json

      - name: Install dependencies
        working-directory: source/atomica-web
        run: npm ci

      - name: Configure environment for GHCR
        working-directory: source/atomica-web
        run: |
          # Create .env file with GHCR configuration
          # Note: GHCR_USERNAME and GHCR_TOKEN are NOT needed in CI
          # GITHUB_TOKEN is automatically used for authentication
          cat > .env << EOF
          # Docker image from GHCR (private registry)
          VALIDATOR_IMAGE_REPO=ghcr.io/0o-de-lally/atomica/zapatos-bin
          IMAGE_TAG=5df0e6d1

          # Network configuration
          TESTNET_NAME=zapatos-testnet
          SUBNET=172.19.0.0/16
          GATEWAY=172.19.0.1
          NUM_VALIDATORS=4
          EOF

      - name: Run docker-testnet tests
        working-directory: source/atomica-web
        run: npm run test:docker
        env:
          # GITHUB_TOKEN is automatically available and has read:packages permission
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Cleanup Docker resources
        if: always()
        working-directory: docker-testnet
        run: |
          docker compose down --remove-orphans -v || true

# Alternative: Build locally instead of using GHCR
#
# If you prefer to build the Docker image from source in CI:
#
# - name: Setup Rust toolchain
#   uses: actions-rust-lang/setup-rust-toolchain@v1
#
# - name: Build Docker image
#   working-directory: docker-testnet
#   run: ./build-local-image.sh
#
# - name: Configure environment for local build
#   working-directory: source/atomica-web
#   run: |
#     cat > .env << EOF
#     VALIDATOR_IMAGE_REPO=zapatos-testnet/validator
#     IMAGE_TAG=latest
#     TESTNET_NAME=zapatos-testnet
#     SUBNET=172.19.0.0/16
#     GATEWAY=172.19.0.1
#     NUM_VALIDATORS=4
#     EOF
#
# - name: Run docker-testnet tests
#   working-directory: source/atomica-web
#   run: npm run test:docker
